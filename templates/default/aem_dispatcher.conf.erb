# Apache2 Version (<%= node['apache']['version'] %>)
# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
<VirtualHost *:<%= @params[:listen_port] %>>
  ServerName <%= @params[:server_name] %>
  ServerAlias <% @params[:server_aliases].each do |a| %><%= "#{a}" %> <% end %>
  DocumentRoot <%= @params[:docroot] %>
  UseCanonicalName Off
  RewriteEngine On
  ExpiresActive On
  TraceEnable Off

  <% if @params[:deflate_enabled] %>
  <IfModule mod_deflate.c>
    SetOutputFilter DEFLATE

    <IfModule mod_setenvif.c>
      # Netscape 4.x has some problems
      BrowserMatch ^Mozilla/4 gzip-only-text/html

      # Netscape 4.06-4.08 have some more problems
      BrowserMatch ^Mozilla/4\.0[678] no-gzip

      # MSIE masquerades as Netscape, but it is fine
      BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

      # Don't compress already-compressed files
      SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary
      SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
      SetEnvIfNoCase Request_URI .(?:avi|mov|mp3|mp4|rm|flv|swf|mp?g)$ no-gzip dont-vary
      SetEnvIfNoCase Request_URI .pdf$ no-gzip dont-vary
    </IfModule>

    <IfModule mod_headers.c>
      # Make sure proxies don't deliver the wrong content
      Header append Vary User-Agent env=!dont-vary
    </IfModule>
  </IfModule>
  <% end %>

  <% if @params[:ssl_enabled] %>
  SSLEngine on
  SSLOptions +StrictRequire

  <Directory />
    SSLRequireSSL
  </Directory>

  SSLProtocol -all +TLSv1 +SSLv3
  SSLCipherSuite HIGH:MEDIUM:!aNULL:+SHA1:+MD5:+HIGH:+MEDIUM

  SSLCertificateFile <%= @params[:ssl_cert_file] %>
  SSLCertificateKeyFile <%= @params[:ssl_key_file] %>
  SSLVerifyClient none
  SSLProxyEngine off

  <IfModule mime.c>
    AddType application/x-x509-ca-cert      .crt
    AddType application/x-pkcs7-crl         .crl
  </IfModule>
  <% end %>

  <% unless @params[:enable_etag] %>
  <IfModule mod_headers.c>
    Header unset ETag
  </IfModule>
  FileETag None
  <% end %>

  <% if @params[:enable_ie_header] %>
  <filesMatch "\.(html|htm)$">
    <ifModule mod_headers.c>
      Header set X-UA-Compatible "IE=9; IE=8; IE=7; IE=EDGE"
    </ifModule>
  </filesMatch>
  <% end %>

  
  <% @params[:aem_locations].each do |dir| %>
  <Directory <%= dir %>>
    ModMimeUsePathInfo On

    <IfModule disp_apache2.c>
      SetHandler dispatcher-handler
    </IfModule>

    Options FollowSymLinks
    AllowOverride None

  </Directory>

  <% end %>
  <Directory "<%= @params[:docroot] %>">
    Options Indexes FollowSymLinks
    AllowOverride None
    <% if ( node["apache"]["version"].to_f < 2.4 ) -%>
    Order Deny,Allow
    Deny from all
    <% else %>
    Require all granted
    <% end %>
  </Directory>

  <% @params[:expire_dirs].each do |dir| %>
  <Location <%= dir[:path] %> >
    <% dir[:rules].each do |rule| %>
    <%= rule %>
    <% end %>
  </Location>

  <% end %>

  <Location /server-status>
    SetHandler server-status

    <% if ( node[:apache][:version].to_f < 2.4 ) -%>
    Order Deny,Allow
    Deny from all
    <% else %>
    Require all granted
    <% end %>
    Allow from 127.0.0.1
  </Location>

  DirectoryIndex index.html index.html.var

  LogLevel info
  ErrorLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-access.log combined

  RewriteEngine On
  <% if ( node[:apache][:version].to_f < 2.4 ) %>
  RewriteLog <%= node[:apache][:log_dir] %>/<%= @application_name %>-rewrite.log
  RewriteLogLevel 0
  <% end %>

  <% @params[:rewrites].each do |rule| %>
  <%=   rule %>
  <% end %>

</VirtualHost>
